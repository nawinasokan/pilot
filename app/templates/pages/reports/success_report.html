{% extends "layouts/base.html" %}

{% block title %}Success Invoice Report{% endblock %}

{% block stylesheets %}

<style>
    .select2-container {
        width: 100% !important;
    }

    .select2-container--default .select2-selection--single {
        height: 42px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        display: flex;
        align-items: center;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        padding-left: 14px;
        color: #495057;
        font-size: 14px;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 42px;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="row">
    <div class="col-12 grid-margin stretch-card">
        <div class="card shadow-sm">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col-md-8">
                         <h6 class="card-title">Success Invoice Report</h6>
                    </div>
                    <div class="col-md-4 text-end">
                        <select id="fileSelect" class="form-control">
                            <option value="">Select Source File</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card-body">
                <div class="d-flex justify-content-end mb-3 d-none" id="exportActions"
                    style="display: none !important;">
                    <button class="btn btn-primary mr-2" onclick="exportExcel()">Excel</button>
                    <button class="btn btn-primary mr-2" onclick="exportCSV()">CSV</button>
                    <button class="btn btn-primary" onclick="exportJSON()">JSON</button>
                </div>

                <div class="table-responsive d-none" id="tableContainer">
                    <table id="successTable" class="table table-hover table-striped">
                        <thead>
                            <tr id="tableHead"></tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>

            </div>

        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script>
    let successTable = null;
    let currentKeys = [];
    let currentSourceFile = "";

    const FIXED_COLUMNS = [
        { key: "batch_master__extraction_batch_id", label: "Batch ID" },
        { key: "source_file_name", label: "Uploaded File" },
        { key: "created_by__username", label: "Uploaded By" },
        { key: "created_at", label: "Uploaded At" },
        { key: "status", label: "Status" }
    ];

    function escapeHtml(val) {
        if (val === null || val === undefined) return "-";
        return String(val)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function renderStatusBadge(status) {
        return `<span class="badge badge-success text-white">${status}</span>`;
    }

    $(document).ready(function () {

        $("#fileSelect").select2({
            placeholder: "Search source file...",
            allowClear: true,
            width: "100%"
        });

        loadSourceFiles();

        $("#fileSelect").on("change", function () {
            const fileName = $(this).val();
            currentSourceFile = fileName || "";

            if (!fileName) {
                hideTable();
                return;
            }

            fetch(`/reports/success/?source_file_name=${encodeURIComponent(fileName)}`, {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
                .then(res => res.json())
                .then(resp => {
                    if (!resp.success || !resp.data.length) {
                        hideTable();
                        return;
                    }
                    populateTable(resp.data);
                })
                .catch(() => hideTable());
        });
    });

    function loadSourceFiles() {
        fetch("/reports/success/", {
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
            .then(res => res.json())
            .then(resp => {
                if (!resp.success) return;

                const select = $("#fileSelect");
                select.empty().append(`<option></option>`);

                resp.source_files.forEach(f => {
                    select.append(new Option(f.source_file_name, f.source_file_name));
                });

                select.trigger("change.select2");
            });
    }

    function formatDateOnly(dateStr) {
        if (!dateStr) return "-";

        const d = new Date(dateStr);
        return d.toLocaleDateString("en-GB", {
            day: "2-digit",
            month: "short",
            year: "numeric"
        });
    }


    function populateTable(rows) {

        $("#tableContainer").removeClass("d-none");
        $("#exportActions").show();

        if ($.fn.DataTable.isDataTable("#successTable")) {
            $("#successTable").DataTable().clear().destroy();
        }

        $("#tableHead").empty();
        $("#tableBody").empty();

        currentKeys = Object.keys(rows[0].extracted_data || {});

        $("#tableHead").append("<th>S.No</th>");

        FIXED_COLUMNS.forEach(col => {
            $("#tableHead").append(`<th>${col.label}</th>`);
        });

        currentKeys.forEach(k => {
            $("#tableHead").append(`<th>${escapeHtml(k)}</th>`);
        });

        rows.forEach(() => {
            let tr = "<tr><td></td>";
            FIXED_COLUMNS.forEach(() => tr += "<td></td>");
            currentKeys.forEach(() => tr += "<td></td>");
            tr += "</tr>";
            $("#tableBody").append(tr);
        });

        successTable = $("#successTable").DataTable({
            pageLength: 10,
            ordering: true,
            searching: true,
            responsive: true,
            columnDefs: [{ targets: 0, orderable: false }],
            language: {
                emptyTable: "No SUCCESS invoices found"
            }
        });

        successTable.rows().every(function (idx) {
            const r = rows[idx];

            const fixedData = FIXED_COLUMNS.map(col => {
                if (col.key === "created_at") {
                    return formatDateOnly(r.created_at);
                }

                if (col.key === "status") {
                    return renderStatusBadge(r.status);
                }
                return escapeHtml(r[col.key] ?? "-");
            });

            const extractedData = currentKeys.map(
                k => escapeHtml(r.extracted_data?.[k] ?? "-")
            );

            this.data([
                idx + 1,
                ...fixedData,
                ...extractedData
            ]);
        });

        successTable.draw();
    }

    function hideTable() {
        $("#tableContainer").addClass("d-none");
        $("#exportActions").addClass("d-none");

        if ($.fn.DataTable.isDataTable("#successTable")) {
            $("#successTable").DataTable().clear().destroy();
        }

        $("#tableHead").empty();
        $("#tableBody").empty();
    }
</script>

{% endblock javascripts %}