{% extends "layouts/base.html" %}
{% load static %}
{% block title %}Invoice Extraction{% endblock %}

{% block stylesheets %}

<style>
    .select2-container {
        width: 100% !important;
    }

    .select2-container .select2-selection--single {
        height: 45px !important;
        border: 1px solid #ced4da !important;
        border-radius: 0.25rem !important;
        display: flex !important;
        align-items: center !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: normal !important;
        padding-left: 15px !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 45px !important;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="grid-margin-sm-0">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">Invoice Extraction</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-10 mb-3">
                            <label class="form-label">Select File / Batch</label>

                            <select id="fileSelect" class="form-select">
                                <option></option>
                                {% for file in files %}
                                <option value="{{ file.batch_id }}" data-filename="{{ file.file_name }}">
                                    {{ file.file_name }} ({{ file.batch_id }})
                                </option>
                                {% endfor %}
                            </select>



                        </div>

                        <div class="col-md-2 mb-3 d-flex align-items-end">
                            <button id="extractBtn" class="btn btn-primary w-100" disabled>
                                Submit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="invoiceTable" class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>S No.</th>
                                    <th>Batch ID</th>
                                    <th>File Name</th>
                                    <th>Status</th>
                                    <th>Success Count</th>
                                    <th>Duplicate Count</th>
                                    <th>Total Count</th>
                                    <th>Uploaded By</th>
                                    <th>Uploaded At</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block javascripts %}

<script>
    const START_API_URL = "/api/invoice-extraction/start/";
    const PROGRESS_API_URL = "/api/invoice-extraction/progress/";

    let table = null;
    let progressInterval = null;
    let isPolling = false;

    let selectedBatchId = null;
    let selectedFileName = null;

    function getCSRFToken() {
        const cookie = document.cookie
            .split("; ")
            .find(row => row.startsWith("csrftoken="));
        return cookie ? cookie.split("=")[1] : "";
    }

    function startPolling(batchId, fileName) {
        if (isPolling) return;
        isPolling = true;

        Swal.fire({
            title: 'AI Extraction in Progress...',
            html: `
            <div id="swal-poll-container" style="text-align:left">
                <p>üìÇ <b>File:</b> ${fileName}</p>
                <div class="progress mb-3" style="height: 20px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                         id="batch-prog-bar" role="progressbar" style="width: 0%">0%</div>
                </div>
                <div class="d-flex justify-content-between">
                    <small>‚úÖ Success: <b id="stat-s">0</b></small>
                    <small>‚ö†Ô∏è Duplicate: <b id="stat-d">0</b></small>
                    <small>‚ùå Failed: <b id="stat-f">0</b></small>
                </div>
            </div>
        `,
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => Swal.showLoading()
        });

        progressInterval = setInterval(async () => {
            try {
                const res = await fetch(`${PROGRESS_API_URL}${batchId}/`);
                const data = await res.json();

                if (!data.success) return;

                const progBar = document.getElementById('batch-prog-bar');
                const s = document.getElementById('stat-s');
                const d = document.getElementById('stat-d');
                const f = document.getElementById('stat-f');

                if (progBar) {
                    progBar.style.width = data.progress_percentage + '%';
                    progBar.innerText = data.progress_percentage + '%';
                }
                if (s) s.innerText = data.stats.success;
                if (d) d.innerText = data.stats.duplicate;
                if (f) f.innerText = data.stats.failed;

                if (data.batch_status !== 'PROCESSING') {
                    clearInterval(progressInterval);
                    isPolling = false;
                    Swal.hideLoading();

                    const finalHtml = `
                    <div style="text-align:left">
                        <p>üìÇ <b>File:</b> ${fileName}</p>
                        <div class="progress mb-3" style="height: 20px;">
                            <div class="progress-bar bg-success" style="width: 100%">100%</div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small>‚úÖ Success: <b>${data.stats.success}</b></small>
                            <small>‚ö†Ô∏è Duplicate: <b>${data.stats.duplicate}</b></small>
                            <small>‚ùå Failed: <b>${data.stats.failed}</b></small>
                        </div>
                    </div>
                `;

                    Swal.update({
                        title: data.batch_status === 'COMPLETED' ? 'Extraction Complete!' : 'Extraction Failed',
                        html: finalHtml,
                        showConfirmButton: true
                    });

                    if (table) table.ajax.reload(null, false);
                }
            } catch (err) {
                console.error("Polling error:", err);
            }
        }, 2000);
    }

    $(document).ready(function () {
        $('#fileSelect').select2({
            placeholder: "Search file or batch...",
            allowClear: true,
            width: '100%'
        });

        $('#fileSelect').on('select2:select', function (e) {
            const option = e.params.data.element;
            selectedBatchId = option.value;
            selectedFileName = option.dataset.filename;
            $('#extractBtn').prop('disabled', false);
        });

        $('#fileSelect').on('select2:unselect', function () {
            selectedBatchId = null;
            selectedFileName = null;
            $('#extractBtn').prop('disabled', true);
        });

        table = $('#invoiceTable').DataTable({
            ajax: {
                url: "{% url 'invoice_extraction_list' %}",
                dataSrc: "data"
            },
            pageLength: 10,
            order: [[8, 'desc']], 
            columns: [
                { data: "sl_no" },
                { data: "extraction_batch_id" },
                { data: "source_file_name" },
                {
                    data: "batch_status",
                    render: function (data) {
                        let cls = "bg-secondary";
                        if (data === "COMPLETED") cls = "bg-success";
                        if (data === "PROCESSING") cls = "bg-info";
                        if (data === "FAILED") cls = "bg-danger";
                        return `<span class="badge ${cls} text-white">${data}</span>`;
                    }
                },
                { data: "success_count" },
                { data: "duplicate_count" },
                {
                    data: null,
                    render: (row) => `${row.batch_processed_count} / ${row.batch_total_count}`
                },
                { data: "created_by" },
                {
                    data: "created_at",
                    render: function (data) {
                        if (!data) return "-";

                        const date = new Date(data);

                        return date.toLocaleDateString("en-GB", {
                            day: "2-digit",
                            month: "short",
                            year: "numeric"
                        });
                    }
                },
                {
                    data: "id",
                    render: (id) => `
                    <button class="btn btn-inverse-danger btn-sm btn-icon delete-confirm d-inline-flex align-items-center justify-content-center mx-1 delete-invoice" 
                    data-id="${id}">
                    <i class="ti-trash"></i>
                    </button>`
                }
            ],
            "drawCallback": function (settings) {
                const api = this.api();
                const rows = api.rows().data().toArray();
                const processingBatch = rows.find(r => r.batch_status === 'PROCESSING');

                if (processingBatch && !isPolling) {
                    console.log("üìÇ Resuming tracking for batch:", processingBatch.extraction_batch_id);
                    startPolling(processingBatch.extraction_batch_id, processingBatch.source_file_name);
                }
            }
        });

        $('#extractBtn').on('click', async function () {
            if (!selectedBatchId || !selectedFileName) return;

            $('#extractBtn').prop('disabled', true);

            try {
                const response = await fetch(START_API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify({
                        batch_id: selectedBatchId,
                        file_name: selectedFileName
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (data.already_processed) {
                        Swal.fire({
                            title: "Already Processed",
                            text: data.message,
                            icon: "warning"
                        });
                    } else {
                        throw new Error(data.message || "Failed to start");
                    }
                    $('#extractBtn').prop('disabled', false);
                    return;
                }

                startPolling(data.extraction_batch_id, selectedFileName);
                table.ajax.reload(null, false);

            } catch (err) {
                Swal.fire("Error", err.message, "error");
                $('#extractBtn').prop('disabled', false);
            }
        });

    $('#invoiceTable').on('click', '.delete-invoice', function () {
        const batchId = $(this).data('id'); 

        Swal.fire({
            title: "Delete Batch?",
            text: "This will remove the batch and all extracted invoice data. This action cannot be undone.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Yes, delete it!",
            allowOutsideClick: false
        }).then(async (result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    title: 'Deleting...',
                    didOpen: () => Swal.showLoading(),
                    allowOutsideClick: false,
                    showConfirmButton: false
                });

                try {
                    const response = await fetch(`/api/invoice-extraction/delete/${batchId}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": getCSRFToken(),
                            "Content-Type": "application/json"
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        Swal.fire("Deleted!", data.message, "success");
                        table.ajax.reload(null, false); 
                    } else {
                        throw new Error(data.message || "Delete failed");
                    }
                } catch (err) {
                    Swal.fire("Error", err.message, "error");
                }
            }
        });
    });

    });
</script>

{% endblock javascripts %}