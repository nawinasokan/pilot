{% extends "layouts/base.html" %}
{% load static %}
{% block title %}Invoice Extraction{% endblock %}

{% block stylesheets %}
<link href="{% static 'vendors/select2/select2.min.css' %}" rel="stylesheet" />

<style>
    .select2-container {
        width: 100% !important;
    }

    .select2-container .select2-selection--single {
        height: 45px !important;
        border: 1px solid #ced4da !important;
        border-radius: 0.25rem !important;
        display: flex !important;
        align-items: center !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: normal !important;
        padding-left: 15px !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 45px !important;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="grid-margin-sm-0">
    <div class="row">

        <div class="col-12 mb-4">
            <div class="card">

                <div class="card-header">
                    <h6 class="card-title mb-0">Invoice Extraction</h6>
                </div>

                <div class="card-body">

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Select File / Batch</label>

                            <select id="fileSelect" class="form-select">
                                <option></option>
                                {% for file in files %}
                                <option value="{{ file.id }}">
                                    {{ file.file_name }} ({{ file.batch_id }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-2 mb-3 d-flex align-items-end">
                            <button id="extractBtn" class="btn btn-primary w-100" disabled>
                                Extract Invoice
                            </button>
                        </div>
                    </div>

                </div>

            </div>
        </div>

    </div>
</div>

{% endblock content %}

{% block javascripts %}
<script src="{% static 'vendors/select2/select2.min.js' %}"></script>
<script>
    const API_URL = "/api/invoice-extraction/start/";
    let selectedBatchId = null;

    $(document).ready(function () {

        // ---------------- Select2 Init ----------------
        $('#fileSelect').select2({
            placeholder: "Search file or batch...",
            allowClear: true,
            width: '100%'
        });

        $('#fileSelect').on('select2:select', function () {
            selectedBatchId = $(this).val();
            $('#extractBtn').prop('disabled', false);
        });

        $('#fileSelect').on('select2:unselect', function () {
            selectedBatchId = null;
            $('#extractBtn').prop('disabled', true);
        });

        // ---------------- Extract Button ----------------
        $('#extractBtn').on('click', async function () {

            if (!selectedBatchId) return;

            $('#extractBtn').prop('disabled', true);

            Swal.fire({
                title: 'Invoice Extraction',
                html: 'AI is processing invoices‚Ä¶<br>Please wait.',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify({
                        batch_id: selectedBatchId
                    })
                });

                let data;
                try {
                    data = await response.json();
                } catch {
                    throw new Error("Invalid server response");
                }

                Swal.close();

                // ---------------- 400 / 500 Handling ----------------
                if (!response.ok) {
                    Swal.fire({
                        title: "Extraction Blocked",
                        html: data.message || "Request failed",
                        icon: "warning"
                    });
                    $('#extractBtn').prop('disabled', false);
                    return;
                }

                // ---------------- API Logical Failure ----------------
                if (!data.success) {
                    Swal.fire({
                        title: "Extraction Failed",
                        html: data.message || "Extraction could not be completed",
                        icon: "error"
                    });
                    $('#extractBtn').prop('disabled', false);
                    return;
                }

                // ---------------- Batch Result Handling ----------------
                const results = data.results || [];

                const successCount   = results.filter(r => r.status === "SUCCESS").length;
                const duplicateCount = results.filter(r => r.status === "DUPLICATE").length;
                const failedCount    = results.filter(r => r.status === "FAILED").length;

                const html = `
                    <div style="text-align:left">
                        üì¶ <b>Total URLs:</b> ${data.total_urls}<br>
                        üîç <b>Processed:</b> ${results.length}<br><br>

                        ‚úÖ <b>Success:</b> ${successCount}<br>
                        ‚ö†Ô∏è <b>Duplicate:</b> ${duplicateCount}<br>
                        ‚ùå <b>Failed:</b> ${failedCount}
                    </div>
                `;

                Swal.fire({
                    title: "Invoice Extraction Completed",
                    html: html,
                    icon: successCount > 0 ? "success" : "warning"
                });

                $('#extractBtn').prop('disabled', false);

            } catch (err) {
                Swal.close();
                Swal.fire({
                    title: "Server Error",
                    text: err.message || "Something went wrong",
                    icon: "error"
                });
                $('#extractBtn').prop('disabled', false);
            }
        });
    });

    // ---------------- CSRF Helper ----------------
    function getCSRFToken() {
        const cookie = document.cookie
            .split("; ")
            .find(row => row.startsWith("csrftoken="));
        return cookie ? cookie.split("=")[1] : "";
    }
</script>

{% endblock javascripts %}
