{% extends "layouts/base.html" %}
{% load static %}
{% block title %}Invoice Extraction{% endblock %}

{% block stylesheets %}

<style>
    .select2-container {
        width: 100% !important;
    }

    .select2-container .select2-selection--single {
        height: 45px !important;
        border: 1px solid #ced4da !important;
        border-radius: 0.25rem !important;
        display: flex !important;
        align-items: center !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: normal !important;
        padding-left: 15px !important;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 45px !important;
    }
</style>
{% endblock stylesheets %}

{% block content %}
<div class="grid-margin-sm-0">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">Invoice Extraction</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-10 mb-3">
                            <label class="form-label">Select File / Batch</label>

                            <select id="fileSelect" class="form-select">
                                <option></option>
                                {% for file in files %}
                                <option value="{{ file.batch_id }}" data-filename="{{ file.file_name }}">
                                    {{ file.file_name }} ({{ file.batch_id }})
                                </option>
                                {% endfor %}
                            </select>



                        </div>

                        <div class="col-md-2 mb-3 d-flex align-items-end">
                            <button id="extractBtn" class="btn btn-primary w-100" disabled>
                                Submit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="invoiceTable" class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>S No.</th>
                                    <th>Batch ID</th>
                                    <th>File Name</th>
                                    <th>Status</th>
                                    <th>Success Count</th>
                                    <th>Duplicate Count</th>
                                    <th>Total Count</th>
                                    <th>Uploaded By</th>
                                    <th>Uploaded At</th>    
                                    <th>Action</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block javascripts %}
<script>
    const API_URL = "/api/invoice-extraction/start/";   

    let selectedBatchId = null;
    let selectedFileName = null;
    let table;

    function getCSRFToken() {
        const cookie = document.cookie
            .split("; ")
            .find(row => row.startsWith("csrftoken="));
        return cookie ? cookie.split("=")[1] : "";
    }

    $(document).ready(function () {

        $('#fileSelect').select2({
            placeholder: "Search file or batch...",
            allowClear: true,
            width: '100%'
        });

        $('#fileSelect').on('select2:select', function (e) {
            const option = e.params.data.element;

            selectedBatchId = option.value;
            selectedFileName = option.dataset.filename;

            console.log("üìÇ FILE SELECTED");
            console.log("batch_id  =", selectedBatchId);
            console.log("file_name =", selectedFileName);

            $('#extractBtn').prop('disabled', false);
        });

        $('#fileSelect').on('select2:unselect', function () {
            selectedBatchId = null;
            selectedFileName = null;
            $('#extractBtn').prop('disabled', true);
        });

        $('#extractBtn').on('click', async function () {

            if (!selectedBatchId || !selectedFileName) {
                Swal.fire("Select a file first", "", "warning");
                return;
            }

            $('#extractBtn').prop('disabled', true);

            Swal.fire({
                title: 'Invoice Extraction',
                html: `
                    <div style="text-align:left">
                        üìÇ <b>File:</b> ${selectedFileName}<br>
                        üì¶ <b>Batch:</b> ${selectedBatchId}<br><br>
                        ü§ñ AI is processing invoices‚Ä¶
                    </div>
                `,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });

            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify({
                        batch_id: selectedBatchId,
                        file_name: selectedFileName   
                    })
                });

                let data;
                try {
                    data = await response.json();
                } catch {
                    throw new Error("Invalid server response");
                }

                Swal.close();

                if (!response.ok || !data.success) {
                    Swal.fire({
                        title: "Extraction Failed",
                        html: data.message || "Request failed",
                        icon: "error"
                    });
                    $('#extractBtn').prop('disabled', false);
                    return;
                }

                const results = data.results || [];

                const successCount = results.filter(r => r.status === "SUCCESS").length;
                const duplicateCount = results.filter(r => r.status === "DUPLICATE").length;
                const failedCount = results.filter(r => r.status === "FAILED").length;

                const html = `
                    <div style="text-align:left">
                        üì¶ <b>Total URLs:</b> ${data.total_urls}<br>
                        üîç <b>Attempted:</b> ${results.length}<br><br>
                        ‚úÖ <b>Success:</b> ${successCount}<br>
                        ‚ö†Ô∏è <b>Duplicate:</b> ${duplicateCount}<br>
                        ‚ùå <b>Failed:</b> ${failedCount}
                    </div>
                `;

                Swal.fire({
                    title: "Invoice Extraction Completed",
                    html: html,
                    icon: successCount > 0 ? "success" : "warning",
                    confirmButtonText: "OK"
                }).then(() => {
                    if (table) {
                        table.ajax.reload(null, false);
                    }
                    $('#fileSelect').val(null).trigger('change');
                    $('#extractBtn').prop('disabled', true);
                });

            } catch (err) {
                Swal.close();
                Swal.fire({
                    title: "Server Error",
                    text: err.message || "Something went wrong",
                    icon: "error"
                });
                $('#extractBtn').prop('disabled', false);
            }
        });
    });


    $(document).ready(function () {

        table = $('#invoiceTable').DataTable({
            ajax: {
                url: "{% url 'invoice_extraction_list' %}",
                dataSrc: "data"   
            },

            pageLength: 10,
            order: [[6, 'desc']],
            autoWidth: false,

            columns: [
                { data: "sl_no" },
                { data: "batch_id" },
                { data: "source_file_name" },

                {
                    data: "status",
                    render: function (data) {
                        if (data === "SUCCESS") {
                            return '<span class="badge bg-success text-white">SUCCESS</span>';
                        }
                        if (data === "DUPLICATE") {
                            return '<span class="badge bg-warning text-white">DUPLICATE</span>';
                        }
                        if (data === "FAILED") {
                            return '<span class="badge bg-danger text-white">FAILED</span>';
                        }
                        return data;
                    }
                },

                {
                    data: "success_count",
                },
                {
                    data: "duplicate_count",
                },
                {
                    data: "total_processed",

                },

                {
                    data: "created_at",
                    render: function (data) {
                        if (!data) return "-";
                        const date = new Date(data);
                        return date.toLocaleDateString("en-GB", {
                            day: "2-digit",
                            month: "short",
                            year: "numeric"
                        });
                    }
                },

                { data: "created_by" },

                {
                    data: "id",
                    orderable: false,
                    render: function (id) {
                        return `
                        <button
                            class="delete-btn btn btn-inverse-danger btn-sm btn-icon delete-confirm d-inline-flex align-items-center justify-content-center mx-1 delete-invoice"
                            data-id="${id}">
                            <i class="ti-trash"></i>
                        </button>
                    `;
                    }
                }
            ],

            columnDefs: [
                { targets: [0, 6], orderable: false }
            ]
        });
    });


    $('#invoiceTable').on('click', '.delete-invoice', function () {

        const invoiceId = $(this).data('id');

        Swal.fire({
            title: "Delete Invoice?",
            text: "This action cannot be undone.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#d33",
            confirmButtonText: "Yes, delete"
        }).then(async (result) => {

            if (!result.isConfirmed) return;

            try {
                const res = await fetch(
                    `/api/invoice-extraction/delete/${invoiceId}/`,
                    {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": getCSRFToken()
                        }
                    }
                );

                const data = await res.json();

                if (!data.success) {
                    throw new Error(data.message || "Delete failed");
                }

                Swal.fire("Deleted!", "Invoice removed.", "success");
                table.ajax.reload(null, false);

            } catch (err) {
                Swal.fire("Error", err.message, "error");
            }
        });
    });
</script>


{% endblock javascripts %}