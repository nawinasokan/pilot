{% extends "layouts/base.html" %}
{% load static %}
{% block title %}Upload Management{% endblock %}

{% block stylesheets %}
{% endblock stylesheets %}

{% block content %} 


<div class="grid-margin-sm-0">
    <div class="row">
        <!-- FILE UPLOAD FORM (TOP) -->
        <div class="col-12 mb-4">
            <div class="card">

                <div class="card-header">
                    <h6 class="card-title mb-0">Upload Management</h6>
                </div>

                <div class="card-body">
                    <form id="uploadManagementForm" method="POST" action="{% url 'create_upload_management' %}" enctype="multipart/form-data">

                        {% csrf_token %}
                        <input type="file" name="file" id="uploadFile" class="form-control" accept=".csv,.xlsx,.xls" required>
                        <button type="submit" class="btn btn-primary w-100">
                            Upload
                        </button>
                    </form>

                </div>

            </div>
        </div>

        <div class="modal fade" id="headerModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Select Header</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <form id="headerForm"></form>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-primary" id="confirmUploadBtn">
                    Confirm Upload
                    </button>
                </div>

                </div>
            </div>
        </div>

        <!-- Header Preview Modal -->
        <div class="modal fade" id="headerPreviewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-md">
                <div class="modal-content">

                    <div class="modal-header">
                        <h5 class="modal-title">Select Header</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">
                        <form id="headerPreviewForm">
                            <!-- headers will be injected here -->
                        </form>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal">
                            Cancel
                        </button>
                        <button class="btn btn-primary" id="confirmHeaderBtn">
                            Confirm Upload
                        </button>
                    </div>

                </div>
            </div>
        </div>


        <!-- FILE UPLOAD LIST (BOTTOM) -->
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="userTable" class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>S.No</th>
                                    <th>File Name</th>
                                    <th>Batch ID</th>
                                    <th>Status</th>
                                    <th>Uploaded At</th>
                                    <th>Uploaded By</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>


{% endblock content %}

{% block javascripts %}

    <script>
        $(document).on('submit', '#uploadManagementForm', function (event) {
            event.preventDefault();

            const form = $(this);
            const fileInput = $('#uploadFile')[0];

            if (!fileInput.files.length) {
                Swal.fire("Error", "Please select a file", "error");
                return;
            }

            const previewData = new FormData();
            previewData.append("file", fileInput.files[0]);

            // STEP 1: Preview Headers
            $.ajax({
                url: "{% url 'preview_file_headers' %}",
                type: "POST",
                data: previewData,
                processData: false,
                contentType: false,
                headers: {
                    "X-CSRFToken": form.find('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {

                    if (!response.success) {
                        Swal.fire("Error", response.message, "error");
                        return;
                    }

                    showHeaderPreviewModal(response.headers);
                },
                error: function () {
                    Swal.fire("Error", "Header preview failed", "error");
                }
            });
        });

        let headerModalInstance = null;

        function showHeaderPreviewModal(headers) {

            const form = $('#headerPreviewForm');
            form.empty();

            headers.forEach((h, i) => {
                form.append(`
                    <div class="form-check mb-2">
                        <input class="form-check-input"
                            type="radio"
                            name="selected_header"
                            id="header_${i}"
                            value="${h}">
                        <label class="form-check-label" for="header_${i}">
                            ${h}
                        </label>
                    </div>
                `);
            });

            headerModalInstance = new bootstrap.Modal(
                document.getElementById('headerPreviewModal')
            );
            headerModalInstance.show();
        }

        $('#confirmHeaderBtn').on('click', function () {

            const selectedHeader = $('input[name="selected_header"]:checked').val();

            if (!selectedHeader) {
                Swal.fire("Error", "Please select a header", "warning");
                return;
            }

            headerModalInstance.hide();

            startUploadWithHeader(selectedHeader);
        });


        function startUploadWithHeader(selectedHeader) {

            const formData = new FormData();
            formData.append("file", $('#uploadFile')[0].files[0]);
            formData.append("selected_header", selectedHeader);

            $.ajax({
                url: "{% url 'create_upload_management' %}",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    "X-CSRFToken": $('[name=csrfmiddlewaretoken]').val()
                },
                success: function (response) {

                    if (response.success) {
                        Swal.fire("Success", response.message, "success");

                        $('#userTable').DataTable().ajax.reload(null, false);
                    } else {
                        Swal.fire("Error", response.message, "error");
                    }
                },
                error: function () {
                    Swal.fire("Error", "Upload failed", "error");
                }
            });
        }


        $(document).ready(function () {
            const table = $('#userTable').DataTable({
                ajax: "{% url 'upload_management_list_api' %}",
                pageLength: 10,
                order: [[4, 'desc']],
                destroy: true,
                autoWidth: false,

                columns: [
                    { data: "sl_no" },
                    { data: "file_name" },
                    { data: "batch_id" },
                    {
                        data: "status",
                            render: function (data) {
                                if (data === "PROCESSING") {
                                    return `
                                        <span class="spinner-border spinner-border-sm text-primary"></span>
                                        Processing
                                    `;
                                }
                                if (data === "COMPLETED") {
                                    return `<span class="badge bg-success">Completed</span>`;
                                }
                                if (data === "FAILED") {
                                    return `<span class="badge bg-danger">Failed</span>`;
                                }
                                return data;
                            }
                    },
                    { data: "created_at" },
                    { data: "created_by" },
                    {
                        data: "id",
                        render: function (id, type, row) {
                            return `
                            <button class="btn btn-inverse-danger btn-sm btn-icon delete-btn delete-confirm d-inline-flex align-items-center justify-content-center mx-1"
                                    data-id="${id}">
                                <i class="ti-trash"></i>
                            </button>
                        `;
                        }
                    }
                ],

                columnDefs: [
                    { targets: [0, 5], orderable: false }
                ]
            });

            $(document).on("click", ".delete-btn", function () {
                const projectId = $(this).data("id");

                Swal.fire({
                    title: "Are you sure?",
                    text: "This project will be permanently deleted!",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Yes, delete it!"
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.post(
                            `/uploads/delete/${projectId}/`,
                            { csrfmiddlewaretoken: "{{ csrf_token }}" },
                            function (res) {
                                Swal.fire("Deleted!", res.message, "success");
                                table.ajax.reload(null, false);
                            }
                        );
                    }
                });
            });
        });


    </script>


{% endblock javascripts %}