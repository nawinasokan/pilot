{% extends "layouts/base.html" %}
{% load static %}
{% block title %}Upload Management{% endblock %}

{% block stylesheets %}
<style>
    .header-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 14px;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        cursor: pointer;
        margin-bottom: 10px;
        transition: all 0.2s ease;
        position: relative;
    }

    .header-option:hover {
        background-color: #f8f9ff;
        border-color: #6366f1;
    }

    .header-option .form-check-input {
        position: static;
        transform: scale(1.1);
    }

    .header-option.selected {
        background-color: #eef2ff;
        border-color: #6366f1;
    }

    .modal-body {
        padding-top: 1rem;
    }

    .modal-header {
        padding-top: 0.75rem;
        padding-bottom: 0.25rem;
    }

    .modal-header .modal-title {
        margin-bottom: 0.15rem;
    }
</style>
{% endblock stylesheets %}

{% block content %}

<div class="grid-margin-sm-0">
    <div class="row">

        <div class="col-12 mb-4">
            <div class="card">

                <div class="card-header">
                    <h6 class="card-title mb-0">Upload Management</h6>
                </div>

                <div class="card-body">
                    <form id="uploadManagementForm" method="POST" action="{% url 'create_upload_management' %}"
                        enctype="multipart/form-data">
                        {% csrf_token %}

                        <div class="row g-2 align-items-center">
                            <div class="col-md-10">
                                <input type="file" name="file" id="uploadFile" class="form-control"
                                    accept=".csv,.xlsx,.xls" required>
                            </div>

                            <div class="col-md-2">
                                <button type="submit" class="btn btn-primary w-100">
                                    Upload
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

            </div>
        </div>

        <div class="modal fade" id="headerPreviewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-md">
                <div class="modal-content border-0 shadow-lg">

                    <div class="modal-header border-0 pb-0">
                        <div>
                            <h5 class="modal-title fw-semibold">Select Header Column</h5>
                            <small class="text-muted">
                                Choose the column that contains the header values
                            </small>
                        </div>
                    </div>

                    <div class="modal-body">
                        <form id="headerPreviewForm" class="header-list">
                        </form>
                    </div>

                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary px-4" id="confirmHeaderBtn" disabled>
                            Confirm Upload
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="userTable" class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>S.No</th>
                                    <th>Batch ID</th>
                                    <th>File Name</th>
                                    <th>Status</th>
                                    <th>Uploaded By</th>
                                    <th>Uploaded At</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

{% endblock content %}

{% block javascripts %}
<script>
    $(document).on('submit', '#uploadManagementForm', function (event) {
        event.preventDefault();

        const form = $(this);
        const fileInput = $('#uploadFile')[0];

        if (!fileInput.files.length) {
            Swal.fire("Error", "Please select a file", "error");
            return;
        }

        const previewData = new FormData();
        previewData.append("file", fileInput.files[0]);

        $.ajax({
            url: "{% url 'preview_file_headers' %}",
            type: "POST",
            data: previewData,
            processData: false,
            contentType: false,
            headers: {
                "X-CSRFToken": form.find('[name=csrfmiddlewaretoken]').val()
            },
            success: function (response) {
                if (!response.success) {
                    Swal.fire("Error", response.message, "error");
                    return;
                }
                showHeaderPreviewModal(response.headers);
            },
            error: function () {
                Swal.fire("Error", "Header preview failed", "error");
            }
        });
    });

    function showHeaderPreviewModal(headers) {

        const form = $('#headerPreviewForm');
        const confirmBtn = $('#confirmHeaderBtn');

        form.empty();
        confirmBtn.prop('disabled', true);

        headers.forEach(header => {
            form.append(`
            <label class="header-option">
                <input type="radio"
                       name="selected_header"
                       value="${header}"
                       class="form-check-input">
                <span class="fw-medium">${header}</span>
            </label>
        `);
        });

        form.off('change').on('change', 'input[name="selected_header"]', function () {
            confirmBtn.prop('disabled', false);
            $('.header-option').removeClass('selected');
            $(this).closest('.header-option').addClass('selected');
        });

        $('#headerPreviewModal').modal({
            backdrop: true,
            keyboard: true,
            show: true
        });
    }

    $('#confirmHeaderBtn').on('click', function () {

        const selectedHeader = $('input[name="selected_header"]:checked').val();

        if (!selectedHeader) {
            Swal.fire("Error", "Please select a header", "warning");
            return;
        }

        $('#headerPreviewModal').modal('hide');
        startUploadWithHeader(selectedHeader);
    });

    function startUploadWithHeader(selectedHeader) {

        const formData = new FormData();
        formData.append("file", $('#uploadFile')[0].files[0]);
        formData.append("selected_header", selectedHeader);

        $.ajax({
            url: "{% url 'create_upload_management' %}",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                "X-CSRFToken": $('[name=csrfmiddlewaretoken]').val()
            },
            success: function (response) {
                if (response.success) {
                    Swal.fire("Success", response.message, "success");

                    const table = $('#userTable').DataTable();
                    table.ajax.reload(null, false);

                    startUploadPolling();
                } else {
                    Swal.fire("Error", response.message, "error");
                }
            }
            ,
            error: function () {
                Swal.fire("Error", "Upload failed", "error");
            }
        });
    }

    let table;

    $(document).ready(function () {

        table = $('#userTable').DataTable({
            ajax: "{% url 'upload_management_list_api' %}",
            pageLength: 10,
            order: [[4, 'desc']],
            autoWidth: false,

            columns: [
                { data: "sl_no" },
                { data: "file_name" },
                { data: "batch_id" },
                {
                    data: "status",
                    render: function (data) {
                        if (data === "PROCESSING") {
                            return `
                            <span class="spinner-border spinner-border-sm text-primary text-white"></span>
                            <span class="text-muted">Processing</span>
                        `;
                        }
                        if (data === "COMPLETED") {
                            return `<span class="badge bg-success text-white">Completed</span>`;
                        }
                        if (data === "FAILED") {
                            return `<span class="badge bg-danger text-white">Failed</span>`;
                        }
                        return data;
                    }
                },
                { data: "created_by" },
                {
                    data: "created_at",
                    render: function (data) {
                        if (!data) return "-";

                        const date = new Date(data);

                        return date.toLocaleDateString("en-GB", {
                            day: "2-digit",
                            month: "short",
                            year: "numeric"
                        });
                    }
                },
                {
                    data: "batch_id",
                    render: function (batchId, type, row) {

                        if (row.status === "PROCESSING") {
                            return `<span class="text-muted">â€”</span>`;
                        }

                        return `
                            <button class="delete-btn btn btn-inverse-danger btn-sm btn-icon delete-confirm d-inline-flex align-items-center justify-content-center mx-1"
                                    data-batch="${batchId}">
                                <i class="ti-trash"></i>
                            </button>
                        `;
                    }
                }

            ],

            columnDefs: [
                { targets: [0, 5], orderable: false }
            ]
        });
    });


    $(document).ready(function () {
        const table = $('#userTable').DataTable();
        setTimeout(() => {
            const hasProcessing = table
                .rows()
                .data()
                .toArray()
                .some(row => row.status === "PROCESSING");

            if (hasProcessing) {
                startUploadPolling();
            }
        }, 1000);
    });


    let uploadStatusPoller = null;

    function startUploadPolling() {
        if (uploadStatusPoller) return;

        uploadStatusPoller = setInterval(() => {
            const table = $('#userTable').DataTable();
            table.ajax.reload(null, false);
            const hasProcessing = table
                .rows()
                .data()
                .toArray()
                .some(row => row.status === "PROCESSING");

            if (!hasProcessing) {
                clearInterval(uploadStatusPoller);
                uploadStatusPoller = null;
            }
        }, 3000);
    }

    $(document).on('click', '.delete-btn', function () {

        const batchId = $(this).data('batch');

        if (!batchId) {
            Swal.fire("Error", "Invalid batch ID", "error");
            return;
        }

        Swal.fire({
            title: "Delete batch?",
            text: `This will permanently delete batch ${batchId}`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Yes, delete",
        }).then((result) => {

            if (!result.isConfirmed) return;

            $.ajax({
                url: `/uploads/delete/${batchId}/`,
                type: "POST",
                data: {
                    csrfmiddlewaretoken: "{{ csrf_token }}"
                },
                success: function (res) {
                    Swal.fire("Deleted", res.message, "success");
                    $('#userTable').DataTable().ajax.reload(null, false);
                },
                error: function (xhr) {
                    Swal.fire(
                        "Error",
                        xhr.responseJSON?.message || "Delete failed",
                        "error"
                    );
                }
            });
        });
    });


</script>
{% endblock javascripts %}